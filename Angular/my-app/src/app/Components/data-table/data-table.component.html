<div class="d-flex justify-content-between container-fluid">
  <div class="d-flex">
    <app-add-organization></app-add-organization>
  </div>
  <app-logout />
</div>

<div class="my-2">
  <input
    pInputText
    type="text"
    placeholder="🔍 Search..."
    (input)="onGlobalFilter($event)"
    class="form-control h-search"
  />
</div>

<p-table
  #dt
  [value]="records"
  [paginator]="true"
  [rows]="5"
  [loading]="loading"
  [rowsPerPageOptions]="[5, 10, 20]"
  responsiveLayout="scroll"
  [globalFilterFields]="[
    'organizationName',
    'expenseAccountName',
    'businessName',
    'locationName',
    'amount',
    'status',
    'createdByUsername'
  ]"
>
  <ng-template pTemplate="header">
    <tr class="text-center">
      <th pSortableColumn="organizationName">
        Organization
        <p-columnFilter field="organizationName" matchMode="contains"></p-columnFilter>
      </th>
      <th pSortableColumn="expenseAccountName">
        Expense
        <p-columnFilter field="expenseAccountName" matchMode="contains"></p-columnFilter>
      </th>
      <th pSortableColumn="businessName">
        Business
        <p-columnFilter field="businessName" matchMode="contains"></p-columnFilter>
      </th>
      <th pSortableColumn="locationName">
        Location
        <p-columnFilter field="locationName" matchMode="contains"></p-columnFilter>
      </th>
      <th pSortableColumn="amount">
        Amount
        <p-columnFilter field="amount" matchMode="gte" display="menu"></p-columnFilter>
      </th>
      <th pSortableColumn="status">
        Status
        <p-columnFilter
          field="status"
          matchMode="equals"
          [showMenu]="false"
          type="text"
        >
          <ng-template pTemplate="filter" let-value let-filter="filterCallback">
            <p-dropdown
              [options]="statusOptions"
              [ngModel]="value"
              (onChange)="filter($event.value)"
              placeholder="Select status"
              [showClear]="true"
              [appendTo]="'body'"
              styleClass="w-100"
            ></p-dropdown>
          </ng-template>
        </p-columnFilter>
      </th>
     
      <th>Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-record>
    <tr class="text-center">
      <td>{{ record.organizationName }}</td>
      <td>{{ record.expenseAccountName }}</td>
      <td>{{ record.businessName }}</td>
      <td>{{ record.locationName }}</td>
      <td>{{ record.amount }}</td>
      <td
        [ngClass]="{
          'status-pending': record.status === 'SAVED',
          'status-canceled': record.status === 'FAILED',
          'status-COMPLETED': record.status === 'COMPLETED',
          'status-approved': record.status === 'APPROVED'
        }"
      >
        {{ record.status }}
      </td>
      <td class="d-flex">
      <div class="d-flex">
          <button
          pButton
          type="button"
          class="btn-sm-crud btn btn-sm mx-1"
          (click)="viewRecord(record)"
        >
          <i class="fa-solid fa-eye"></i>
        </button>




          <button
          pButton
           *ngIf="role === 'ROLE_RELEASER'"
          type="button"
          class="btn-sm-crud btn btn-sm mx-1"
         (click)="openStatusDialog(record)"
        >
        change status
        </button>






        <button
          *ngIf="role === 'ROLE_ENTRY' || role === 'ROLE_APPROVER'"
          pButton
          type="button"
          class="btn-sm-crud btn btn-sm mx-1"
          (click)="updatePop(record)"
        >
          <i class="fas fa-edit"></i>
        </button> 
      </div>

    <button
          *ngIf="role === 'ROLE_APPROVER' || role === 'ROLE_ADMIN'"
          pButton
          type="button"
          class="btn-sm-crud btn btn-sm mx-1"
          (click)="cancleApprove(record)"
        >
          Cancel OR Approve
        </button>
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  header="📄 View Record"
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{ width: '40vw' }"
  (onHide)="selectedRecord = null"
>
<div *ngIf="selectedRecord" class="p-3">
  <h5>Record Details</h5>
  <ul class="list-group">
    <li class="list-group-item"><b>ID:</b> {{ selectedRecord.id }}</li>
    <li class="list-group-item"><b>Organization Code:</b> {{ selectedRecord.organizationCode }}</li>
    <li class="list-group-item"><b>Organization Name:</b> {{ selectedRecord.organizationName }}</li>
    <li class="list-group-item"><b>Legal Entity:</b> {{ selectedRecord.legalEntity }}</li>
    <li class="list-group-item"><b>Remitter Bank:</b> {{ selectedRecord.remitterBank }}</li>
    <li class="list-group-item"><b>Remitter Account:</b> {{ selectedRecord.remitterBankAccount }}</li>
    <li class="list-group-item"><b>Remitter Account Name:</b> {{ selectedRecord.remitterBankAccountName }}</li>
    <li class="list-group-item"><b>Biller ID:</b> {{ selectedRecord.billerId }}</li>
    <li class="list-group-item"><b>Biller Name:</b> {{ selectedRecord.billerName }}</li>
    <li class="list-group-item"><b>Vendor Number:</b> {{ selectedRecord.vendorNumber }}</li>
    <li class="list-group-item"><b>Vendor Name:</b> {{ selectedRecord.vendorName }}</li>
    <li class="list-group-item"><b>Vendor Site Code:</b> {{ selectedRecord.vendorSiteCode }}</li>
    <li class="list-group-item"><b>Invoice Type:</b> {{ selectedRecord.invoiceType }}</li>
    <li class="list-group-item"><b>Invoice Number:</b> {{ selectedRecord.invoiceNumber }}</li>
    <li class="list-group-item"><b>Subscription Account:</b> {{ selectedRecord.subscriptionAccountNumber }}</li>
    <li class="list-group-item"><b>Amount:</b> {{ selectedRecord.amount }}</li>
    <li class="list-group-item"><b>Expense Account:</b> {{ selectedRecord.expenseAccountName }} ({{ selectedRecord.expenseAccountCode }})</li>
    <li class="list-group-item"><b>Business:</b> {{ selectedRecord.businessName }} ({{ selectedRecord.businessCode }})</li>
    <li class="list-group-item"><b>Location:</b> {{ selectedRecord.locationName }} ({{ selectedRecord.locationCode }})</li>
    <li class="list-group-item"><b>Status:</b> {{ selectedRecord.status }}</li>
    <li class="list-group-item"><b>Created By:</b> {{ selectedRecord.createdByUsername }}</li>
    <li class="list-group-item"><b>Created At:</b> {{ selectedRecord.createdAt | date:'short' }}</li>
    <li class="list-group-item"><b>Updated At:</b> {{ selectedRecord.updatedAt || '---' }}</li>
    <li class="list-group-item"><b>Updated By:</b> {{ selectedRecord.updatedBy || '---' }}</li>
  </ul>
</div>

</p-dialog>

<p-dialog
  header="✏ Update Record"
  [(visible)]="displayDialogg"
  [modal]="true"
  [style]="{ width: '50vw' }"
  (onHide)="selectedRecordd = null"
>
  <app-update-organization
    *ngIf="selectedRecordd"
    [record]="selectedRecordd"
  ></app-update-organization>
</p-dialog>

<p-dialog
  header="Change Status"
  [(visible)]="displayDialoggg"
  [modal]="true"
  [style]="{ width: '30vw' }"
  (onHide)="selectedRecordForStatus = null"
>
  <app-pending-status
    *ngIf="selectedRecordForStatus"
    [record]="selectedRecordForStatus"
  ></app-pending-status>
</p-dialog>
<p-dialog
  header="Change Status"
  [(visible)]="showStatusDialog"
  [modal]="true"
  [style]="{ width: '40vw' }"
  (onHide)="selectedId = null"
>
<app-sadad-release *ngIf="selectedId" [id]="selectedId"></app-sadad-release>
</p-dialog>


<p-dialog
  header="⚖ Cancel / Approve"
  [(visible)]="canlepop"
  [modal]="true"
  [style]="{ width: '30vw' }"
  (onHide)="selectedRecordForStatus = null"
>
<app-agree
  *ngIf="selectedRecordForStatus"
  [recordId]="selectedRecordForStatus"
></app-agree>

</p-dialog>
